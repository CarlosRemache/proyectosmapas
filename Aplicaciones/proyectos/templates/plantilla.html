{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Hábitos de Estudio </title>

    <!-- Manifest PWA -->
    <link rel="manifest" href="{% url 'manifest' %}">

    <!-- Colores para la barra del navegador/móvil -->
    <meta name="theme-color" content="#000000">
    <meta name="background-color" content="#000000">

    <!-- Icono para navegadores -->
    <link rel="icon" href="{% static 'icons/icon-192x192.png' %}">


    <!--Importado jquery -->
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>

    <!--implementacion de cdn de boobstrp-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!--implementacion de izitoad-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js" integrity="sha512-Zq9o+E00xhhR/7vJ49mxFNJ0KQw1E1TMWkPTxrWcnpfEFDEXgUiwJHIKit93EW/XxE31HSI5GEOW06G6BF1AtA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.css" integrity="sha512-DIW4FkYTOxjCqRt7oS9BFO+nVOwDL4bzukDyDtMO7crjUZhwpyrWBFroq+IqRe6VnJkTpRAS6nhDvf0w+wHmxg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> 
 
    
    <!--implementacion de jquery validate-->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.js"></script>

    <!-- FULLCALENDAR -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- DataTables Buttons -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>

    <!-- Exportación Excel / CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

    <!-- Exportación PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  </head>
<body>



    {% block contenido %}

    {% endblock %}
<br>
<br>



<!--verificacion y mostrando mensajes-->
{% if messages %}
    {% for msg in messages %}
        <script>
            {% if msg.tags == 'success' %}
                iziToast.success({
                    title: 'CONFIRMACIÓN',
                    message: "{{ msg|escapejs }}",
                    position: 'topRight'
                });
            {% elif msg.tags == 'error' %}
                iziToast.error({
                    title: 'ERROR',
                    message: "{{ msg|escapejs }}",
                    position: 'topRight'
                });
            {% endif %}
        </script>
    {% endfor %}
{% endif %}

<script>
  const INTERVALO = 30000; // 30 segundos para notificacion
  let timerInterval = null;

  function parseISOToLocalDate(iso){
    // "2025-12-23T00:50:00"
    if(!iso) return null;
    const [datePart, timePart] = iso.split("T");
    const [y,m,d] = datePart.split("-").map(Number);
    const [hh,mm,ss] = timePart.split(":").map(Number);
    return new Date(y, m-1, d, hh, mm, ss || 0);
  }

  function detenerNotificaciones(){
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
    console.log(" Notificaciones detenidas: evento ya terminó.");
  }

  async function consultarYMostrar() {
    try {
      const resp = await fetch("{% url 'usuario_toast_evento' %}");
      const data = await resp.json();

      if (!data.ok) return;

      //  si hay fin, y ya pasó, DETENER
      const finDate = parseISOToLocalDate(data.fin_iso);
      if (finDate && new Date() > finDate) {
        detenerNotificaciones();
        return;
      }

      iziToast.info({
        title: 'EVENTO ASIGNADO',
        message:
          "<div style='line-height:1.4'>" +
            "<div><b>Inicio:</b> " + data.inicio + "</div>" +
            "<div><b>Fin:</b> " + data.fin + "</div>" +
            "<div><b>Descripción:</b> " + data.descripcion + "</div>" +
          "</div>",
        position: 'topRight',
        timeout: 12000,
        close: true,
        progressBar: true
      });

    } catch (e) {
      console.log("❌ Error:", e);
    }
  }

  // arranca al minuto y repite cada minuto, pero se corta al llegar el FIN
  setTimeout(() => {
    consultarYMostrar();
    timerInterval = setInterval(consultarYMostrar, INTERVALO);
  }, INTERVALO);
</script>


    <script>
      jQuery.validator.addMethod("letras", function(value, element) {            
          return this.optional(element) || /^[A-Za-zÁÉÍÓÚÑáéíóúñ ]*$/.test(value);
         
        }, "Este campo solo acepta letras"); 
  </script>

  <!-- Registro del Service Worker PWA -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", function() {
      navigator.serviceWorker.register("/service-worker.js")
        .then(function(registration) {
          console.log("ServiceWorker registrado con scope:", registration.scope);
        })
        .catch(function(error) {
          console.log("Error al registrar el ServiceWorker:", error);
        });
    });
  }
</script>

  
</body>
</html>

