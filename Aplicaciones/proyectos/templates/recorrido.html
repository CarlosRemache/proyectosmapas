{% extends "./plantilla.html" %}
{% load static %}
{% block contenido %}

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet"href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body {
            background-color: #000 !important;
            padding: 0;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        /* Tarjeta contenedora del mapa + info */
        .card-mapa {
            width: 90%;
            max-width: 900px;
            background-color: #222;
            margin: 30px auto;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        #mapa {
            height: 600px;
            width: 100%;
            border-radius: 15px;
        }

        .titulo-mapa {
            text-align: center;
            margin-bottom: 10px;
            color: #fff;
        }

        .acciones-rutas{
            margin-top:18px;
            display:flex;
            gap:12px;
            justify-content:space-between;
        }

        .btn-accion{
            flex:1;
            text-align:center;
            padding:12px 0;
            border-radius:30px;
            font-weight:bold;
            font-size:16px;
            text-decoration:none;
            border:none;
            cursor:pointer;
            transition:0.15s;
        }

        .btn-cancelar{
            background:#111;
            color:#00e53a;
            border:2px solid #00e53a;
            box-shadow:0 3px 10px rgba(0,0,0,0.5);
        }

        .btn-cancelar:hover{
            background:#191919;
        }

        .btn-ir{
            background:#00e53a;
            color:#fff;
            box-shadow:0 4px 14px rgba(0,229,58,0.55);
        }

        .btn-ir:hover{
            background:#00c732;
        }
    </style>
  </head>
  <body>


<div class="card-mapa">

    <div class="titulo-mapa">
        <h3>Recorrido del Auto</h3>
    </div>
    <div id="mapa"></div>

    <div class="tarjeta-info" id="opciones-rutas">

        <div class="acciones-rutas">
            <a href="/inicio/" id="btnDetener" class="btn-accion btn-cancelar">Detener</a>

            <button id="btnUbicacionRecorrido" type="button" class="btn-accion btn-ir">
                Activar
            </button>
            
        </div>

    </div>

</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map('mapa').setView([-0.9333, -78.6167], 15);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const iconOrigen = L.icon({
            iconUrl: '{% static "img/punto.png" %}',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });

        const iconDestino = L.icon({
            iconUrl: '{% static "img/puntorojo.png" %}',
            iconSize: [25, 25],
            iconAnchor: [15, 15]
        });


        const phoneIcon = L.icon({
            iconUrl: '{% static "img/punto.png" %}',
            iconSize: [35, 35],
            iconAnchor: [17, 17]
        });

        const origen = JSON.parse('{{ origen_real|escapejs }}');
        const destino = JSON.parse('{{ destino_real|escapejs }}');

        // (Opcional) marcador origen si quieres:
        // L.marker([origen.latitud, origen.longitud], { icon: iconOrigen }).addTo(map).bindPopup(`Origen: ${origen.nombre}`);

        const markerDestino = L.marker([destino.latitud, destino.longitud], { icon: iconDestino })
            .addTo(map)
            .bindPopup(`Destino: ${destino.nombre}`);

        const rutas = JSON.parse('{{ rutas_js|escapejs }}');
        const colorRuta = '{{ color_ruta }}';

        if (rutas && rutas.length > 0) {
            const coords = rutas[0];
            const poly = L.polyline(coords, { color: colorRuta, weight: 6 }).addTo(map);
            map.fitBounds(poly.getBounds(), { padding: [50, 50] });
        } else {
            const bounds = L.latLngBounds(
            [origen.latitud, origen.longitud],
            [destino.latitud, destino.longitud]
            );
            map.fitBounds(bounds, { padding: [50, 50] });
        }

        setTimeout(() => map.invalidateSize(), 300);

        // =========================
        // 2) MARKER DEL TELÉFONO
        // =========================
        let phoneMarker = null;

        function paintMarker(lat, lon) {
            const coords = [lat, lon];
            if (!phoneMarker) {
            phoneMarker = L.marker(coords, { icon: phoneIcon }).addTo(map);
            } else {
            phoneMarker.setLatLng(coords);
            }
            map.panTo(coords);
        }

        // =========================
        // 3) WEBSOCKET + RECONEXIÓN
        // =========================
        let socket = null;
        let socketRetries = 0;
        let socketTimer = null;

        function wsUrl() {
            return (window.location.protocol === "https:" ? "wss://" : "ws://") +
                window.location.host + "/ws/ubicacion/";
        }

        function connectSocket(onMessageCb) {
            if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
            return;
            }

            socket = new WebSocket(wsUrl());

            socket.onopen = () => {
            socketRetries = 0;
            console.log("WS conectado (recorrido)");
            };

            socket.onmessage = onMessageCb;

            socket.onclose = () => {
            console.warn("WS cerrado (recorrido), reintentando...");
            scheduleReconnect(onMessageCb);
            };

            socket.onerror = () => {
            console.warn("WS error (recorrido), cerrando...");
            try { socket.close(); } catch(e) {}
            };
        }

        function scheduleReconnect(onMessageCb) {
            if (socketTimer) return;
            const delay = Math.min(15000, 1000 * Math.pow(2, socketRetries)); // 1s,2s,4s... max 15s
            socketRetries++;
            socketTimer = setTimeout(() => {
            socketTimer = null;
            connectSocket(onMessageCb);
            }, delay);
        }

        function handleWSMessage(e) {
            try {
            const data = JSON.parse(e.data);
            if (data && typeof data.latitud !== "undefined" && typeof data.longitud !== "undefined") {
                paintMarker(data.latitud, data.longitud);
            }
            } catch(err) {
            console.log("WS parse error:", err);
            }
        }

        // =========================
        // 4) GPS WATCH + RESUME
        // =========================
        let watchId = null;

        function sendLocation(lat, lon) {
            // pinta inmediato
            paintMarker(lat, lon);

            // envía al WS si está abierto
            if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                latitud: lat,
                longitud: lon,
                vehiculo_id: {{ vehiculo.id_vehiculo|default:0 }},
                guardar: true
            }));
            }
        }

        function startWatch() {
            if (!("geolocation" in navigator)) {
            alert("Tu navegador no soporta geolocalización.");
            return;
            }
            if (watchId !== null) return;

            watchId = navigator.geolocation.watchPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                localStorage.setItem("last_lat", lat);
                localStorage.setItem("last_lon", lon);

                sendLocation(lat, lon);
            },
            (err) => {
                console.log("Geo error:", err);
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
            );

            console.log("watchPosition iniciado (recorrido):", watchId);
        }

        function stopWatch() {
            if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
            console.log("watchPosition detenido (recorrido)");
            }
        }

        function onResume(callback) {
            document.addEventListener("visibilitychange", () => {
            if (!document.hidden) callback();
            });
            window.addEventListener("focus", callback);
            window.addEventListener("online", callback);
            window.addEventListener("pageshow", callback);
        }

        // =========================
        // 5) ACTIVAR / DETENER
        // =========================
        function setBtnActivo() {
            const btn = document.getElementById("btnUbicacionRecorrido");
            btn.disabled = true;
            btn.textContent = "Activado";
            btn.style.backgroundColor = "#28a745";
        }

        function setBtnInactivo() {
            const btn = document.getElementById("btnUbicacionRecorrido");
            btn.disabled = false;
            btn.textContent = "Activar";
            btn.style.backgroundColor = "";
        }

        function activarRecorrido() {
            localStorage.setItem("ubicacion_activa", "1");

            // Reconecta WS y arranca GPS
            connectSocket(handleWSMessage);
            startWatch();

            setBtnActivo();
        }

        function detenerRecorrido() {
            localStorage.removeItem("ubicacion_activa");
            stopWatch();

            try { if (socket) socket.close(); } catch(e) {}
            socket = null;

            setBtnInactivo();
        }

        document.getElementById("btnUbicacionRecorrido").addEventListener("click", (e) => {
            e.preventDefault();
            activarRecorrido();
        });

        // Detener (si quieres que también corte el watch antes de ir a /inicio/)
        document.getElementById("btnDetener").addEventListener("click", (e) => {
        e.preventDefault();
        detenerRecorrido();
        window.location.href = "/inicio/";
        });




        // =========================
        // 6) AUTO-REANUDAR (sin refrescar)
        // =========================
        document.addEventListener("DOMContentLoaded", () => {
            // pinta última ubicación guardada
            const lastLat = localStorage.getItem("last_lat");
            const lastLon = localStorage.getItem("last_lon");
            if (lastLat && lastLon) paintMarker(parseFloat(lastLat), parseFloat(lastLon));

            // si estaba activo, reanuda
            if (localStorage.getItem("ubicacion_activa") === "1") {
            activarRecorrido();
            }
        });

        onResume(() => {
            if (localStorage.getItem("ubicacion_activa") === "1") {
            console.log("Resume recorrido: reactivando WS + GPS");
            connectSocket(handleWSMessage);
            if (watchId === null) startWatch();

            const lastLat = localStorage.getItem("last_lat");
            const lastLon = localStorage.getItem("last_lon");
            if (lastLat && lastLon) paintMarker(parseFloat(lastLat), parseFloat(lastLon));
            }
        });


    </script>

  </body>
</html>


{% endblock %}
