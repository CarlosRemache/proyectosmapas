{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Hábitos de Estudio </title>


    <!-- Manifest PWA -->
    <link rel="manifest" href="{% url 'manifest' %}">

    <!-- Colores para la barra del navegador/móvil -->
    <meta name="theme-color" content="#000000">
    <meta name="background-color" content="#000000">

    <!-- Icono para navegadores -->
    <link rel="icon" href="{% static 'icons/icon-192x192.png' %}">




        <!-- calendario -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    <!-- jQuery (solo una vez) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

    <!-- DataTables Buttons -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css">
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>

    <!-- Exportación Excel / CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

    <!-- Exportación PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- iziToast -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/js/iziToast.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/izitoast/1.4.0/css/iziToast.css"/>

    <!-- jQuery Validate -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/additional-methods.min.js"></script>

    <!-- Plantilla CSS -->
    <link href="{% static 'plantilla/assets/vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">

    <link href="{% static 'plantilla/assets/img/favicon.png' %}" rel="icon">
    <link href="{% static 'plantilla/assets/img/apple-touch-icon.png' %}" rel="apple-touch-icon">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&family=Poppins:wght@100;300;400;500;600;700;800;900&family=Raleway:wght@100;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Main CSS -->
    <link href="{% static 'plantilla/assets/css/main.css' %}" rel="stylesheet">

  </head>


<body class="index-page">

  <header id="header" class="header dark-background d-flex flex-column">
    <i class="header-toggle d-xl-none bi bi-list"></i>

    <nav id="navmenu" class="navmenu">
      <ul>
        <li><a href="/adminpanel/" class="active"><i class="bi bi-house navicon"></i>Inicio</a></li>

        <li><a href="/listadousuario/"><i class="bi bi-person navicon"></i> Control de Usuarios</a></li>
        <li><a href="/reporteviaje/"><i class="bi bi-person navicon"></i> Control de viajes</a></li>
        <li><a href="/reportehistorial/"><i class="bi bi-person navicon"></i> historial de viajes</a></li>
  
        <li><a href="/logout/"> Cerrar sesión</a></li>
      </ul>
    </nav>

  </header>

    {% block contener %}

    {% endblock %}
<br>
<br>



<!--verificacion y mostrando mensajes-->
{% if messages %}
  {% for message in messages %}
    <script>
      (function() {
        const tipo = "{{ message.tags }}";
        const texto = "{{ message|escapejs }}";

        if (tipo === "success") {
          iziToast.success({
            title: 'CONFIRMACIÓN',
            message: texto,
            position: 'topRight'
          });
        } 
        else if (tipo === "error") {
          iziToast.error({
            title: 'ERROR',
            message: texto,
            position: 'topRight'
          });
        } 
        else if (tipo === "warning") {
          iziToast.warning({
            title: 'ADVERTENCIA',
            message: texto,
            position: 'topRight'
          });
        }
        else {
          iziToast.info({
            title: 'INFO',
            message: texto,
            position: 'topRight'
          });
        }
      })();
    </script>
  {% endfor %}
{% endif %}

<script>
      jQuery.validator.addMethod("letras", function(value, element) {            
          return this.optional(element) || /^[A-Za-zÁÉÍÓÚÑáéíóúñ ]*$/.test(value);
         
        }, "Este campo solo acepta letras"); 
</script>
  

<footer id="footer" class="footer position-relative light-background">

    <div class="container">
      <div class="copyright text-center ">
        <p> <span></span> <strong class="px-1 sitename"></strong> <span></span></p>
      </div>
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you've purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: [buy-url] -->
        <a href="https://bootstrapmade.com/"></a>  <a href="https://themewagon.com"></a>
      </div>
    </div>

  </footer>

  <!-- Scroll Top -->
  <a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Preloader -->
  <div id="preloader"></div>




  <!-- Vendor JS Files -->
  <script src="{% static 'plantilla/assets/vendor/bootstrap/js/bootstrap.bundle.min.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/php-email-form/validate.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/aos/aos.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/typed.js/typed.umd.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/purecounter/purecounter_vanilla.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/waypoints/noframework.waypoints.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/glightbox/js/glightbox.min.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/imagesloaded/imagesloaded.pkgd.min.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/isotope-layout/isotope.pkgd.min.js'   %}"></script>
  <script src="{% static 'plantilla/assets/vendor/swiper/swiper-bundle.min.js'  %}"></script>

  <!-- Main JS File -->
  <script src="{% static 'plantilla/assets/js/main.js' %}"> </script>


    <!-- Registro del Service Worker PWA -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function() {
        navigator.serviceWorker.register("/service-worker.js")
          .then(function(registration) {
            console.log("ServiceWorker registrado con scope:", registration.scope);
          })
          .catch(function(error) {
            console.log("Error al registrar el ServiceWorker:", error);
          });
      });
    }
  </script>

<script>
(function () {
  // Solo aplica al adminpanel (ajusta si tu URL base es distinta)
  if (!location.pathname.startsWith(
    "/adminpanel",

    // usuarios
    "/listadousuario",
    "/nuevousuario",
    "/editarusuarioadministrador",
    "/procesareditarusuarioadministrador",
    "/eliminarusuarioadministrador",
    "/editarusuario",
    "/procesareditarusuario",

    // vehiculos
    "/nuevovehiculo",
    "/listadovehiculo",
    "/editarvehiculo",
    "/procesareditarvehiculo",
    "/eliminarvehiculo",

    // carga/peso
    "/listadocarga",
    "/nuevacarga",
    "/editarcarga",
    "/procesareditarcarga",
    "/eliminarcarga",

    // mapa/lugares
    "/buscarlugares",
    "/lugar/",
    "/guardar_lugar/",
    "/eliminar_lugar/",

    // rutas e historial
    "/rutas",
    "/recorrido",
    "/historial",
    "/historial/eliminar/",
    "/api/ruta-optima/",

    // calendario (todo cuelga de /panel/)
    "/panel/",
    "/lista_asignaciones",
    "/crear_asignacion",
    "/asignaciones/editar/",
    "/asignaciones/eliminar/",

    // proveedores
    "/listadoproveedor",
    "/nuevoproveedor",
    "/editarproveedor",
    "/procesareditarproveedor",
    "/eliminarproveedor",

    // pedidos y detalle
    "/listadopedido",
    "/nuevopedido",
    "/editarpedido",
    "/procesareditarpedido",
    "/eliminarpedido",
    "/listadodetalle/",
    "/nuevodetalle/",
    "/editardetalle",
    "/procesareditardetalle",
    "/eliminardetalle",
    "/agregarproducto",
    "/redirigir_detalle/",

    // reportes
    "/reporteviaje",
    "/reportehistorial",

    // facturas
    "/nuevafactura",
    "/crear_factura",
    "/ver_factura/",
    "/listadofacturas",
    "/factura/pdf/",
    "/eliminarfactura",

    // salvoconductos
    "/salvoconductos",
    "/nuevosalvoconducto",
    "/editarsalvoconducto/",
    "/eliminarsalvoconducto/",
    "/salvoconducto/pdf/",
    "/validar/salvoconducto/",

    // pagos
    "/pago/",
    "/guardar_pago",
    "/pagos",
    "/pagos/ver/",
    "/pagos/editar/",
    "/pagos/eliminar/"  
  )) return;

  // Identificador único por pestaña
  const TAB_ID = (crypto?.randomUUID?.() || (Date.now() + "-" + Math.random())).toString();
  const LOCK_KEY = "ADMINPANEL_ACTIVE_TAB_LOCK";
  const HEARTBEAT_MS = 2000;      // cada 2s actualiza
  const TIMEOUT_MS = 7000;        // si no late en 7s, se considera libre

  // Oculta la página hasta decidir si puede entrar
  document.documentElement.style.visibility = "hidden";

  function now() { return Date.now(); }

  function readLock() {
    try { return JSON.parse(localStorage.getItem(LOCK_KEY) || "null"); }
    catch (e) { return null; }
  }

  function writeLock(obj) {
    localStorage.setItem(LOCK_KEY, JSON.stringify(obj));
  }

  function lockIsAlive(lock) {
    return lock && (now() - lock.ts) < TIMEOUT_MS;
  }

  function acquireLockOrBlock() {
    const lock = readLock();

    // Si no hay lock o está muerto -> tomarlo
    if (!lock || !lockIsAlive(lock)) {
      writeLock({ tabId: TAB_ID, ts: now() });
      document.documentElement.style.visibility = "visible";
      return true;
    }

    // Si el lock ya es mío -> ok
    if (lock.tabId === TAB_ID) {
      document.documentElement.style.visibility = "visible";
      return true;
    }

    // Lock vivo y de otra pestaña -> bloquear
    try { sessionStorage.setItem("adminpanel_blocked", "1"); } catch(e){}
    location.replace("/tab-bloqueada/");
    return false;
  }

  // Mantener vivo el lock si soy el dueño
  const interval = setInterval(() => {
    const lock = readLock();
    if (lock && lock.tabId === TAB_ID) {
      writeLock({ tabId: TAB_ID, ts: now() });
    }
  }, HEARTBEAT_MS);

  // Si cierro la pestaña dueña, libero lock (no siempre se garantiza, pero ayuda)
  window.addEventListener("beforeunload", () => {
    const lock = readLock();
    if (lock && lock.tabId === TAB_ID) {
      localStorage.removeItem(LOCK_KEY);
    }
    clearInterval(interval);
  });

  // Sincronización entre pestañas
  let bc = null;
  try {
    bc = new BroadcastChannel("adminpanel_channel");
    bc.onmessage = (ev) => {
      if (ev.data === "LOCK_TAKEN") {
        const lock = readLock();
        if (lock && lock.tabId !== TAB_ID && lockIsAlive(lock)) {
          location.replace("/tab-bloqueada/");
        }
      }
    };
  } catch(e) {}

  // Cuando tomo lock, aviso a otras pestañas
  const ok = acquireLockOrBlock();
  if (ok && bc) bc.postMessage("LOCK_TAKEN");

})();
</script>

  

</body>
</html>

