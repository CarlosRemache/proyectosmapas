
{% extends "./plantilla.html" %}
{% load static %}
{% block contenido %}

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>localizacion de autos</title>
     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
 
     <style>
      body {
          padding: 0;
          margin: 0;
      }

      html, body, #map {
          height: 100%;
          width: 100vw;
      }


      #btnUbicacion {
        position: absolute;
        top: 220px;
        left: 15px;
        z-index: 1000;
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      }

      #btnUbicacion:hover {
        background-color: #0056b3;
      }

      .leaflet-top.leaflet-left {
        top: 100px;
      }

     </style>
 
  </head>
  <body>
        
  <nav class="navbar navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDarkNavbar" aria-controls="offcanvasDarkNavbar" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasDarkNavbar" aria-labelledby="offcanvasDarkNavbarLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="offcanvasDarkNavbarLabel">Menú</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="/perfilusuario/"><i class="bi bi-person-circle me-2"></i>Perfil</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/creardocumento/"><i class="bi bi-card-checklist"></i> Documento indispensables</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-car-front-fill"></i>
                Vehículo
              </a>
              <ul class="dropdown-menu dropdown-menu-dark">
                <li><a class="dropdown-item" href="/nuevovehiculo/"><i class="bi bi-car-front-fill"></i> Agregar Vehículo</a></li>
                <li><a class="dropdown-item" href="/listadovehiculo/"><i class="bi bi-car-front-fill"></i> Ver Vehículo</a></li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/historial/"><i class="bi bi-card-text"></i> Historial</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/buscarlugares/"><i class="bi bi-pin-map"></i> Buscar Navegación</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/logout/"><i class="bi bi-x-circle"></i> Cerrar Sesión</a>
            </li>
          </ul>

        </div>
      </div>
    </div>
  </nav>



  <button id="btnUbicacion">Activar ubicación</button>
    <div id="map"></div> 

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
      
      const map = L.map('map').setView([-0.9333, -78.6167], 15); 
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
      }).addTo(map);


      const phoneIcon = L.icon({
        iconUrl: '{% static "img/punto.png" %}',
        iconSize: [35, 35],
        iconAnchor: [17, 17] 
      });


      let phoneMarker = null;

      function paintMarker(lat, lon) {
        const coords = [lat, lon];
        if (!phoneMarker) {
          phoneMarker = L.marker(coords, { icon: phoneIcon }).addTo(map);
        } else {
          phoneMarker.setLatLng(coords);
        }
        map.panTo(coords);
      }


      let socket = null;
      let socketRetries = 0;
      let socketTimer = null;

      function wsUrl() {
        return (window.location.protocol === "https:" ? "wss://" : "ws://") +
          window.location.host + "/ws/ubicacion/";
      }

      function connectSocket(onMessageCb) {
        if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
          return;
        }

        socket = new WebSocket(wsUrl());

        socket.onopen = () => {
          socketRetries = 0;
          console.log("WS conectado");
        };

        socket.onmessage = onMessageCb;

        socket.onclose = () => {
          console.warn("WS cerrado, reintentando...");
          scheduleReconnect(onMessageCb);
        };

        socket.onerror = () => {
          console.warn("WS error, cerrando...");
          try { socket.close(); } catch(e) {}
        };
      }

      function scheduleReconnect(onMessageCb) {
        if (socketTimer) return;

        const delay = Math.min(15000, 1000 * Math.pow(2, socketRetries)); // 1s,2s,4s... max 15s
        socketRetries++;

        socketTimer = setTimeout(() => {
          socketTimer = null;
          connectSocket(onMessageCb);
        }, delay);
      }


      let watchId = null;

      function startWatch(sendFn) {
        if (!("geolocation" in navigator)) {
          alert("Tu navegador no soporta geolocalización.");
          return;
        }

        if (watchId !== null) return;

        watchId = navigator.geolocation.watchPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            localStorage.setItem("last_lat", lat);
            localStorage.setItem("last_lon", lon);

            sendFn(lat, lon);
          },
          (err) => {
            console.log("Geo error:", err);
          },
          { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 }
        );

        console.log("watchPosition iniciado:", watchId);
      }

      function stopWatch() {
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          console.log("watchPosition detenido");
        }
      }


      function onResume(callback) {
        document.addEventListener("visibilitychange", () => {
          if (!document.hidden) callback();
        });

        window.addEventListener("focus", callback);
        window.addEventListener("online", callback);
        window.addEventListener("pageshow", callback);
      }


      function handleWSMessage(e) {
        const data = JSON.parse(e.data);
        paintMarker(data.latitud, data.longitud);
      }

      function sendLocation(lat, lon) {
        paintMarker(lat, lon);

        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({
            latitud: lat,
            longitud: lon,
            vehiculo_id: {{ vehiculo.id_vehiculo|default:0 }},
            guardar: true
          }));
        }
      }

      function activarUbicacion() {
        localStorage.setItem("ubicacion_activa", "1");

        connectSocket(handleWSMessage);
        startWatch(sendLocation);

        const btn = document.getElementById("btnUbicacion");
        btn.disabled = true;
        btn.textContent = "Ubicación activada";
        btn.style.backgroundColor = "#28a745";
      }


      document.getElementById("btnUbicacion").addEventListener("click", activarUbicacion);

      document.addEventListener("DOMContentLoaded", () => {

        const lastLat = localStorage.getItem("last_lat");
        const lastLon = localStorage.getItem("last_lon");
        if (lastLat && lastLon) paintMarker(parseFloat(lastLat), parseFloat(lastLon));

  
        if (localStorage.getItem("ubicacion_activa") === "1") {
          activarUbicacion();
        }
      });


      onResume(() => {
        if (localStorage.getItem("ubicacion_activa") === "1") {
          console.log("Resume: reactivando WS + GPS");

          connectSocket(handleWSMessage);

          if (watchId === null) {
            startWatch(sendLocation);
          }

          const lastLat = localStorage.getItem("last_lat");
          const lastLon = localStorage.getItem("last_lon");
          if (lastLat && lastLon) paintMarker(parseFloat(lastLat), parseFloat(lastLon));
        }
      });
    </script>
  </body>

</html>

{% endblock %} 
